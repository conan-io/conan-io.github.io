I"7<p>Today we released a Conan package <a href="https://github.com/lasote/conan-boost">Boost/1.66.0@conan/stable</a> on <a href="https://bintray.com/conan/conan-center">conan-center</a>.</p>

<p>This package contains binaries for <strong>more than 150 different</strong> configurations: Windows (different flavors of Visual Studio),
Linux (gcc and clang compilers), OSX. In all systems, it is possible to use different architectures, build types,
or choose if we want to link statically, dynamically, or even to use boost header-only libraries.</p>

<p>But this package also includes large improvements for cross-building boost to different platforms, like Raspberry PI, or Android.
This amazing work has been done thanks to many contributions from the (conan) community, thank you all!!!</p>

<p><a href="https://bintray.com/conan/conan-center">Conan-center</a> only includes the most mainstream binaries, those for Windows,
Linux and OSX, but this post explain how you can use conan to easily cross-build Boost to those platforms.</p>

<h2 id="the-conan-model">The conan model</h2>

<p>Conan packages are defined by recipes, which are python scripts, describing how to build and package the library.
With one conan recipe, many different binary packages can be created, i.e: one for Windows Visual Studio 14, another one for Linux GCC 6 and so on.
Conan package recipes are responsible for translating the user settings (os, architecture, compiler, etc) and call the underlying library‚Äôs
build system with the right options/flags, generating a different binary package for different input settings.</p>

<p>Both package recipes and binaries for all platforms and configurations can be uploaded to the same conan server,
to share them with the team. From now on, if any developer wants to work with this library and there is already a binary generated
for the requested configuration (settings/options) then the library is going to be retrieved directly from the server.
It will save a huge amount of time to any developer of CI process, especially when we are talking about big and complex libraries like boost.</p>

<p class="centered">
    <img src="http://localhost:4000/assets/post_images/2018-01-30/conan_model.png" align="center" width="500" />
</p>

<p>When the user runs ‚Äúconan install‚Äù to retrieve the dependencies for his project, Conan will download the recipe,
evaluate it with their settings/options, and download the  binary matching the user‚Äôs configuration.</p>

<h2 id="cross-building-boost-with-boost-build-b2">Cross building Boost with Boost Build (b2)</h2>

<p>The Boost Build system (aka b2) <a href="http://www.boost.org/doc/libs/1_66_0/libs/context/doc/html/context/architectures/crosscompiling.html">accepts some arguments</a>
to define the cross-compilation:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>architecture, address-model, binary-format, mfloat-abi, abi, target-os
</code></pre></div></div>

<p>In our case, if we want to cross-build to a Android/ARM system, the arguments to pass to ‚Äúb2‚Äù are:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>architecture=arm
address-model=32
binary-format=elf
abi=appcs
target-os=android
</code></pre></div></div>

<p>Hence the command like command would be:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ b2 architecture=arm address-model=32 binary-format=elf
  abi=aapcs target-os=android link=static variant=release
  --without-python  -j8 --abbreviate-paths -d2 --debug-configuration
  --build-dir=‚Äùmy_build_folder"
</code></pre></div></div>

<p>But this is not enough because boost has some third-party dependencies, like <strong>zlib</strong> or <strong>bzip2</strong>.
The user also needs to set some environment configuration, the build tools and compilers paths, the details of
the toolchain and compilations flags has to be specified. To do it the best approach is to define an <code class="highlighter-rouge">user-config.jam</code>
file with the details for cross-building, which could look like:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>using zlib : 1.2.11 : &lt;include&gt;/.conan/data/zlib/1.2.11/conan/stable/package/39a53587004d75943e385925ca011baeab537de0/include
&lt;search&gt;/.conan/data/zlib/1.2.11/conan/stable/package/39a53587004d75943e385925ca011baeab537de0/lib ;
using clang : 5 : "arm-linux-androideabi-clang++"  :
&lt;archiver&gt;"/path/to/arm_21_toolchain/bin/arm-linux-androideabi-ar"
&lt;ranlib&gt;"/path/to//arm_21_toolchain/bin/arm-linux-androideabi-ranlib"
&lt;cxxflags&gt;"-fPIC  -I/path/to/arm_21_toolchain/include/c++/4.9.x"
&lt;cflags&gt;"-fPIC  -I/path/to/arm_21_toolchain/include/c++/4.9.x" &lt;ldflags&gt;""  ;
</code></pre></div></div>

<p>This is an important detail if we want to cross-build Boost for Android,
it should link against cross-built versions of zlib and bzip2 for the same configuration we are cross-building Boost.</p>

<p class="centered">
    <img src="http://localhost:4000/assets/post_images/2018-01-30/boost_deps.png" align="center" width="300" />
</p>

<p>It could be a huge challenge for any developer and a real impediment.
Fortunately, <a href="https://bintray.com/conan/conan-center">conan-center</a> repository already contains zlib and bzip2 packages with
pre-built binaries for hundreds of configurations, but most importantly:
they also know how to cross-build themselves, using their own build systems.</p>

<h2 id="creating-boost-packages-with-native-and-cross-build-binaries">Creating Boost packages with native and cross-build binaries</h2>

<p>There are two ways of creating binary packages. The first one is using ‚Äúconan create‚Äù, typically used by package
creators to explicitly build and test packages before uploading them. This process usually starts cloning a repository
that contains the conan package recipe:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ git clone -b release/1.66.0 https://github.com/lasote/conan-boost
$ conan create . myuser/testing
</code></pre></div></div>

<p>The second way is to consume existing packages. End users can create a <code class="highlighter-rouge">conanfile.txt</code> or <code class="highlighter-rouge">conanfile.py</code>, declaring the necessary package
dependency, and then use the command, ‚Äúconan install‚Äù (more info <a href="http://docs.conan.io/en/latest/getting_started.html#getting-started">getting started</a>).</p>

<p>A <strong>conanfile.txt</strong> to consume the boost library looks like:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[requires]
boost/1.66.0@conan/stable
</code></pre></div></div>

<p>The ‚Äúconan install‚Äù command will try to download a pre-built binary package for developer‚Äôs default configuration
(more info <a href="http://docs.conan.io/en/latest/reference/config_files/default_profile.html">default profile</a>),
but it can fail if there is no binary for the requested configuration.
The ‚Äú‚Äìbuild missing‚Äù argument should be used in this case forcing conan to build the library from
sources with the library recipe. The command should be:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ conan install . --build missing
</code></pre></div></div>

<p>In both cases, to specify which configuration do you want to build, it is very handy to use
<a href="http://docs.conan.io/en/latest/reference/profiles.html">profiles</a>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ conan install . --build missing --profile my_clang_profile
</code></pre></div></div>

<p>The profiles are plain text files defining settings, options, environment variables, and build requirements.</p>

<p>A default profile for OSX  could be:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[settings]
os=Macos
os_build=Macos
arch=x86_64
arch_build=x86_64
compiler=apple-clang
compiler.version=9.0
compiler.libcxx=libc++
build_type=Release
[options]
[build_requires]
[env]
</code></pre></div></div>

<p>If we want to cross-compile to Raspberry PI from Windows, we could install the correct toolchain and define the following profile:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~/.conan/profiles/rpi
target_host=arm-linux-gnueabihf
standalone_toolchain=C:/sysgcc/raspberry
cc_compiler=gcc
cxx_compiler=g++

[settings]
os_build=Windows
arch_build=x86_64
os=Linux
arch=armv7 # Change to armv6 if you are using Raspberry 1
compiler=gcc
compiler.version=6
compiler.libcxx=libstdc++11
build_type=Release

[env]
CONAN_CMAKE_FIND_ROOT_PATH=$standalone_toolchain/$target_host/sysroot
PATH=[$standalone_toolchain/bin]
CHOST=$target_host
AR=$target_host-ar
AS=$target_host-as
RANLIB=$target_host-ranlib
LD=$target_host-ld
STRIP=$target_host-strip
CC=$target_host-$cc_compiler
CXX=$target_host-$cxx_compiler
CXXFLAGS=-I"$standalone_toolchain/$target_host/lib/include"
</code></pre></div></div>

<p>And use this profile with <a href="http://docs.conan.io/en/latest/creating_packages/getting_started.html">conan create</a>
which would build the library, in the local cache, with the settings specified in our profile ‚Äúrpi‚Äù:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ conan create . conan/stable --profile=rpi
</code></pre></div></div>

<p>You can follow <a href="http://docs.conan.io/en/latest/systems_cross_building/cross_building.html#windows-to-raspberry-pi-linux-arm">this guide</a>
in the conan docs to know more about compiling for Raspberry PI.</p>

<p>If you want to cross build a Conan package you need:</p>

<ul>
  <li>The correct toolchain (compiler and tools)</li>
  <li>A profile that describe the settings and the needed environment variables to locate the toolchain.</li>
</ul>

<h2 id="creating-boost-packages-for-android">Creating Boost packages for Android</h2>

<h3 id="preparing-the-android-toolchain">Preparing the Android toolchain</h3>

<p>The Android toolchain can be generated from the <a href="https://developer.android.com/ndk/downloads/index.html">Android NDK</a>.</p>

<p>From the NDK version r16 is only supported ‚Äúclang‚Äù compiler and ‚Äúlibc++‚Äù as the standard c++ library.</p>

<p>You can <a href="https://developer.android.com/ndk/downloads/index.html">download the NDK</a> and invoke the ‚Äúmake_standalone_toolchain.py‚Äù
script specifying the api level, architecture and standard library:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cd build/tools
$ python make_standalone_toolchain.py --arch=arm --api=21 --stl=libc++ --install-dir=/myfolder/arm_21_toolchain
</code></pre></div></div>

<h3 id="preparing-the-conan-profile">Preparing the Conan profile</h3>

<p>Copy and paste this profile in your profiles folder (~/.conan/profiles) adjusting the path to the new
standalone toolchain (replace <em>‚Äú/myfolder/arm_21_toolchain‚Äù</em> with your install path):</p>

<p><strong>.conan/profiles/android_21_armeabi-v7a_clang</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>standalone_toolchain=/myfolder/arm_21_toolchain
target_host=arm-linux-androideabi
cc_compiler=clang
cxx_compiler=clang++

[settings]
compiler=clang
compiler.version=5.0
compiler.libcxx=libc++
os=Android
os.api_level=21
arch=armv7
build_type=Release

[env]
CONAN_CMAKE_FIND_ROOT_PATH=$standalone_toolchain/sysroot
PATH=[$standalone_toolchain/bin]
CHOST=$target_host
AR=$target_host-ar
AS=$target_host-as
RANLIB=$target_host-ranlib
CC=$target_host-$cc_compiler
CXX=$target_host-$cxx_compiler
LD=$target_host-ld
STRIP=$target_host-strip
CFLAGS= -fPIC  -I$standalone_toolchain/include/c++/4.9.x
CXXFLAGS= -fPIC  -I$standalone_toolchain/include/c++/4.9.x
LDFLAGS=
</code></pre></div></div>

<h3 id="building-boost-package-for-android">Building Boost package for Android</h3>

<p>In <a href="https://bintray.com/conan/conan-center">conan-center</a> you can find binaries for known platforms like Windows,
OSX and Linux but not for Android.
In this section we are going to build boost for Android and upload the resulting package to a repository where
it can be consumed by other developers, not building the boost library from sources again in the process.</p>

<p>We are going to use the ‚Äúconan create‚Äù command, so we need to clone the recipe repository:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone -b release/1.66.0 https://github.com/lasote/conan-boost
conan create . conan/stable --build missing --profile=android_21_armeabi-v7_clang
</code></pre></div></div>

<p>With the ‚Äú‚Äìbuild missing‚Äù parameter we are telling conan to build from sources any transitive dependency
for the specified profile, in this case Conan will cross-build also <strong>zlib</strong> and <strong>bzip2</strong>.</p>

<p>Now we can upload the generated binary packages to a conan-server, Artifactory or Bintray.
Check the <a href="http://docs.conan.io/en/latest/uploading_packages.html">Uploading packages</a> section in the docs.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; conan upload boost/1.66.0@conan/stable --all -r=myremote
&gt; conan upload zlib* --all -r=myremote
&gt; conan upload bzip2* --all -r=myremote
# or just
&gt; conan upload * --all -r=myremote
</code></pre></div></div>

<p>We could also share profiles, remotes and settings among the team with the <a href="http://docs.conan.io/en/latest/reference/commands/consumer/config.html">conan config install</a> command.</p>

<p>At this point the binary packages for Android are in my-remote (i.e: <a href="https://bintray.com/conan/conan-center">conan-center</a>)
and developers using the
above profile can reuse them without building from sources the whole boost library.</p>

<p>In a <strong>following blog post</strong> we will create an android app, using the boost library, with an Android Studio
project and a simple ‚Äúconanfile.txt‚Äù. We will explain how to build the same app for multiple architectures (arm, x86 ‚Ä¶)
and package everything in a single apk.</p>
:ET