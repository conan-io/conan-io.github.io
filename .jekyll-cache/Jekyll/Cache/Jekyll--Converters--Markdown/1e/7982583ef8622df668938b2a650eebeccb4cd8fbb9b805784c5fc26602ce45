I"¼4<p>Packaging C/C++ is not very difficult, as long as you have a well known, documented, relatively portable build setup for your library. OpenSSL builds very differently in different operating systems, using different tools and commands. Thus, creating binary packages from sources, in a portable manner, for someone whoâ€™s not savvy with their build system, is challenging, just because building it is challenging.</p>

<p>This post describes how to achieve a fully automated build for <a href="https://www.openssl.org/">OpenSSL</a> packages in multiple platforms.</p>

<h1 id="openssl-requirements">OpenSSL requirements</h1>

<p>One of the biggest challenges to achieve easy builds for a library is defining a simple way to install its required dependencies.</p>

<p>OpenSSL has an optional dependency on <a href="https://zlib.net/">ZLib</a>, which can be configured at build time as an <strong>optional requirement</strong>. It is possible to build different binaries of OpenSSL with or without using ZLib compression.</p>

<p>In Windows, OpenSSL uses Perl and Nasm (Native Assembler) for its builds. In Nix systems, OpenSSL uses configure and make. While we can assume that the compiler (e.g. Visual Studio) is a prerequisite and it is already installed on the developerâ€™s machine, having both Perl and Nasm as default prerequisites for a C or C++ developer is too much.</p>

<p class="centered">
    <img src="http://localhost:4000/assets/post_images/2017-07-04/requirements.png" align="center" />
</p>

<p>While ZLib must be installed at development time, when the developer is linking their code to OpenSSL, Perl and Nasm are only necessary when building OpenSSL from sources. If we already have a pre-built binary package for OpenSSL, then Perl and Nasm are no longer necessary and the developer doesnâ€™t even need to install them. So, weâ€™ll call Perl and Nasm build-requirements. You can find the Conan packages for both <a href="https://bintray.com/conan-community/conan/nasm%3Aconan">Nasm</a> and <a href="https://bintray.com/conan-community/conan/strawberryperl%3Aconan">StrawberryPerl</a> in Bintrayâ€™s <a href="http://docs.conan.io/en/latest/packaging/using_bintray.html">Conan-Center</a>.</p>

<p>Conan has built-in mechanisms to define both scenarios. Hereâ€™s the relevant section for the OpenSSL Conan package recipe:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">build_requirements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># useful for example for conditional build_requires
</span>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">os</span> <span class="o">==</span> <span class="s">"Windows"</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_requires</span><span class="p">(</span><span class="s">"strawberryperl/5.26.0@conan/stable"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_requires</span><span class="p">(</span><span class="s">"nasm/2.13.01@conan/stable"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">requirements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">no_zlib</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requires</span><span class="p">(</span><span class="s">"zlib/1.2.11@conan/stable"</span><span class="p">)</span>
</code></pre></div></div>

<h1 id="cross-platform-openssl-package-building">Cross-platform OpenSSL package building</h1>

<p>As introduced above, OpenSSL has different build commands and arguments in different platforms. Instead of defining build instructions in a README file, and having developers manually follow them, the Conan package recipe basically converts these steps in a readable Python script:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>       <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">os</span> <span class="o">==</span> <span class="s">"Linux"</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">linux_build</span><span class="p">(</span><span class="n">config_options_string</span><span class="p">)</span>
       <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">os</span> <span class="o">==</span> <span class="s">"Macos"</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">osx_build</span><span class="p">(</span><span class="n">config_options_string</span><span class="p">)</span>
       <span class="k">elif</span> <span class="o">...</span>
 
   <span class="k">def</span> <span class="nf">linux_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_options_string</span><span class="p">):</span>
       <span class="n">m32_suff</span> <span class="o">=</span> <span class="s">" -m32"</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">arch</span> <span class="o">==</span> <span class="s">"x86"</span> <span class="k">else</span> <span class="s">""</span>
       <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">build_type</span> <span class="o">==</span> <span class="s">"Debug"</span><span class="p">:</span>
           <span class="n">config_options_string</span> <span class="o">=</span> <span class="s">"-d no-asm -g3 -O0 -fno-omit-frame-pointer "</span> \
                                   <span class="s">"-fno-inline-functions"</span> <span class="o">+</span> <span class="n">config_options_string</span>
 
       <span class="n">m32_pref</span> <span class="o">=</span> <span class="s">"setarch i386"</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">arch</span> <span class="o">==</span> <span class="s">"x86"</span> <span class="k">else</span> <span class="s">""</span>
       <span class="n">config_line</span> <span class="o">=</span> <span class="s">"</span><span class="si">%</span><span class="s">s ./config -fPIC </span><span class="si">%</span><span class="s">s </span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">m32_pref</span><span class="p">,</span> <span class="n">config_options_string</span><span class="p">,</span> <span class="n">m32_suff</span><span class="p">)</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">config_line</span><span class="p">)</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">run_in_src</span><span class="p">(</span><span class="n">config_line</span><span class="p">)</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">run_in_src</span><span class="p">(</span><span class="s">"make depend"</span><span class="p">)</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">run_in_src</span><span class="p">(</span><span class="s">"make"</span><span class="p">)</span>
 
   <span class="k">def</span> <span class="nf">osx_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_options_string</span><span class="p">):</span>
       <span class="n">m32_suff</span> <span class="o">=</span> <span class="s">" -m32"</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">arch</span> <span class="o">==</span> <span class="s">"x86"</span> <span class="k">else</span> <span class="s">""</span>
       <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">arch</span> <span class="o">==</span> <span class="s">"x86_64"</span><span class="p">:</span>
           <span class="n">command</span> <span class="o">=</span> <span class="s">"./Configure darwin64-x86_64-cc </span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="n">config_options_string</span>
       <span class="k">else</span><span class="p">:</span>
           <span class="n">command</span> <span class="o">=</span> <span class="s">"./config </span><span class="si">%</span><span class="s">s </span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">config_options_string</span><span class="p">,</span> <span class="n">m32_suff</span><span class="p">)</span>
</code></pre></div></div>

<p>With over 240 lines of code, the OpenSSL Conan recipe is one of the most complex and longest recipes, due to this variability. Together with the automation of the ZLib conditional requirement as well as the build-requirements to StrawberryPerl and Nasm, it allows the creation of more than 80 different binaries for multiple compilers and versions in Windows, Linux and OSX. Hereâ€™s the current matrix for the <a href="https://bintray.com/conan/conan-center?filterByPkgName=OpenSSL%3Aconan">OpenSSL package</a> in Conan-Center:</p>

<p class="centered">
    <img src="http://localhost:4000/assets/post_images/2017-07-04/matrix.png" align="center" />
</p>

<p>The above matrix is a sneak preview for a new feature that will be available in the next Conan release v0.25 :)</p>

<p>Creating the binaries, testing them and automatically uploading them to Bintray, is a fully automated process using the Travis and Appveyor public and free Continuous Integration services. Take a look at the <a href="https://github.com/lasote/conan-openssl">Conan OpenSSL package recipe</a> repository to see how this is done.</p>

<h2 id="building-other-configurations">Building other configurations</h2>
<p>The above matrix shows the current binaries stored in Bintray, but that doesnâ€™t mean that other configurations will not work. If you try to install Conan for an older version of Visual Studio (version 9) in Windows, youâ€™ll get the following error:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>conan <span class="nb">install </span>OpenSSL/1.0.2l@conan/stable <span class="nt">-s</span> <span class="nv">compiler</span><span class="o">=</span><span class="s2">"Visual Studio"</span> <span class="nt">-s</span> compiler.version<span class="o">=</span>9 <span class="nt">-s</span> <span class="nb">arch</span><span class="o">=</span>x86
<span class="o">&gt;</span> ERROR: Missing prebuilt package <span class="k">for</span> <span class="s1">'OpenSSL/1.0.2l@conan/stable'</span>
</code></pre></div></div>

<p>This means that there is no pre-compiled binary for this configuration. But you can try building it from sources with the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>conan <span class="nb">install </span>OpenSSL/1.0.2l@conan/stable <span class="nt">-s</span> <span class="nv">compiler</span><span class="o">=</span><span class="s2">"Visual Studio"</span> <span class="nt">-s</span> compiler.version<span class="o">=</span>9 <span class="nt">-s</span> <span class="nb">arch</span><span class="o">=</span>x86 <span class="nt">--build</span><span class="o">=</span>missing
</code></pre></div></div>

<p>ZLib will be built from sources too, as there is no pre-built binary for VS 9 for ZLib either.</p>

<p>This command will fire the installation in Windows of StrawberryPerl and Nasm too, of course. Once you have the OpenSSL package, you can safely remove them, install again and you will notice they are not retrieved again.</p>

<h1 id="conclusion">Conclusion</h1>

<p>In this blog post we described how to achieve a reproducible build that includes the conditional (Windows only) automatic installation of required dev tools such as Nasm and Perl. These tools are installed locally, and apply only to the OpenSSL build, which keeps the development machine unpolluted. We also demonstrated automatic management of the ZLib dependency for the major OSs, Windows, Linux and OSX.</p>

<p>The OpenSSL package recipe has been reported also to work for other configurations, including MinGW (it works in Appveyor, but keep in mind that itâ€™s not fully tested). Please try it yourself and report in <a href="https://github.com/lasote/conan-openssl">github repository</a> if necessary to improve support for other platforms.</p>
:ET